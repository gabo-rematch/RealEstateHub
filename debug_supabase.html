<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Debug Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .debug-section h3 { margin-top: 0; color: #333; }
        .log-output { background: #1e1e1e; color: #fff; padding: 15px; border-radius: 4px; min-height: 200px; overflow-y: auto; white-space: pre-wrap; font-size: 12px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .info { color: #17a2b8; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 300px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Supabase Debug Tool - UAE Property Portal</h1>
        
        <div class="debug-section">
            <h3>Connection Configuration</h3>
            <div>
                <input type="text" id="supabaseUrl" placeholder="Supabase URL" value="">
                <input type="password" id="supabaseKey" placeholder="Supabase Anon Key" value="">
                <button onclick="testConnection()">Test Connection</button>
                <button onclick="loadFromEnv()">Load from Environment</button>
            </div>
        </div>

        <div class="debug-section">
            <h3>Debug Actions</h3>
            <button onclick="testTableAccess()">Test Table Access</button>
            <button onclick="testBasicQuery()">Test Basic Query</button>
            <button onclick="testQueryWithFilters()">Test Query with Filters</button>
            <button onclick="testPermissions()">Test Permissions</button>
            <button onclick="getSampleData()">Get Sample Data</button>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>

        <div class="debug-section">
            <h3>Debug Output</h3>
            <div id="debugOutput" class="log-output"></div>
        </div>
    </div>

    <script>
        let supabase = null;
        const output = document.getElementById('debugOutput');

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            output.innerHTML = '';
        }

        function loadFromEnv() {
            // Try to load from current environment or use placeholder values
            document.getElementById('supabaseUrl').value = 'https://oxfibueovlhulfseukzl.supabase.co';
            document.getElementById('supabaseKey').value = 'YOUR_ANON_KEY_HERE';
            log('Environment values loaded. Please update with actual credentials.', 'info');
        }

        async function testConnection() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;

            if (!url || !key) {
                log('Please provide both Supabase URL and Key', 'error');
                return;
            }

            log('=== TESTING CONNECTION ===', 'info');
            log(`URL: ${url}`, 'info');
            log(`Key: ${key.substring(0, 20)}...`, 'info');

            try {
                supabase = window.supabase.createClient(url, key);
                log('Supabase client created successfully', 'success');

                // Test basic connectivity
                const { data, error } = await supabase.from('inventory_unit_preference').select('count', { count: 'exact', head: true });
                
                if (error) {
                    log(`Connection error: ${error.message}`, 'error');
                    log(`Error code: ${error.code}`, 'error');
                    log(`Error details: ${JSON.stringify(error.details)}`, 'error');
                    log(`Error hint: ${error.hint}`, 'error');
                } else {
                    log(`Connection successful! Table has ${data || 0} records`, 'success');
                }
            } catch (e) {
                log(`Connection failed: ${e.message}`, 'error');
            }
        }

        async function testTableAccess() {
            if (!supabase) {
                log('Please test connection first', 'error');
                return;
            }

            log('=== TESTING TABLE ACCESS ===', 'info');

            // Test 1: Check if table exists
            try {
                const { error } = await supabase.from('inventory_unit_preference').select('*', { count: 'exact', head: true });
                if (error) {
                    log(`Table access error: ${error.message}`, 'error');
                } else {
                    log('Table exists and is accessible', 'success');
                }
            } catch (e) {
                log(`Table access exception: ${e.message}`, 'error');
            }

            // Test 2: List available tables (if permissions allow)
            try {
                const { data, error } = await supabase.rpc('version');
                if (error) {
                    log(`RPC call failed: ${error.message}`, 'error');
                } else {
                    log(`Database version: ${data}`, 'info');
                }
            } catch (e) {
                log(`RPC exception: ${e.message}`, 'error');
            }
        }

        async function testBasicQuery() {
            if (!supabase) {
                log('Please test connection first', 'error');
                return;
            }

            log('=== TESTING BASIC QUERIES ===', 'info');

            const tests = [
                { name: 'Select PK only', query: () => supabase.from('inventory_unit_preference').select('pk').limit(3) },
                { name: 'Select basic fields', query: () => supabase.from('inventory_unit_preference').select('pk, id, updated_at').limit(3) },
                { name: 'Select with JSONB', query: () => supabase.from('inventory_unit_preference').select('pk, id, data, updated_at').limit(3) },
                { name: 'No constraints', query: () => supabase.from('inventory_unit_preference').select('*').limit(5) },
                { name: 'With null check', query: () => supabase.from('inventory_unit_preference').select('*').not('data', 'is', null).limit(5) }
            ];

            for (const test of tests) {
                try {
                    log(`Running: ${test.name}`, 'info');
                    const { data, error } = await test.query();
                    if (error) {
                        log(`  Error: ${error.message}`, 'error');
                    } else {
                        log(`  Success: ${data?.length || 0} records`, 'success');
                        if (data && data.length > 0) {
                            log(`  Sample: ${JSON.stringify(data[0], null, 2)}`, 'info');
                        }
                    }
                } catch (e) {
                    log(`  Exception: ${e.message}`, 'error');
                }
            }
        }

        async function testQueryWithFilters() {
            if (!supabase) {
                log('Please test connection first', 'error');
                return;
            }

            log('=== TESTING QUERIES WITH FILTERS ===', 'info');

            const filterTests = [
                { name: 'Filter by kind=listing', query: () => supabase.from('inventory_unit_preference').select('*').eq('data->kind', 'listing').limit(5) },
                { name: 'Filter by kind=client_request', query: () => supabase.from('inventory_unit_preference').select('*').eq('data->kind', 'client_request').limit(5) },
                { name: 'Filter by transaction_type=sale', query: () => supabase.from('inventory_unit_preference').select('*').eq('data->transaction_type', 'sale').limit(5) },
                { name: 'Filter by transaction_type=rent', query: () => supabase.from('inventory_unit_preference').select('*').eq('data->transaction_type', 'rent').limit(5) }
            ];

            for (const test of filterTests) {
                try {
                    log(`Running: ${test.name}`, 'info');
                    const { data, error } = await test.query();
                    if (error) {
                        log(`  Error: ${error.message}`, 'error');
                    } else {
                        log(`  Success: ${data?.length || 0} records`, 'success');
                        if (data && data.length > 0) {
                            log(`  Sample JSONB: ${JSON.stringify(data[0].data, null, 2)}`, 'info');
                        }
                    }
                } catch (e) {
                    log(`  Exception: ${e.message}`, 'error');
                }
            }
        }

        async function testPermissions() {
            if (!supabase) {
                log('Please test connection first', 'error');
                return;
            }

            log('=== TESTING PERMISSIONS ===', 'info');

            // Test different permission scenarios
            const permissionTests = [
                { name: 'Read access test', action: 'SELECT', query: () => supabase.from('inventory_unit_preference').select('pk').limit(1) },
                { name: 'Count access test', action: 'COUNT', query: () => supabase.from('inventory_unit_preference').select('*', { count: 'exact', head: true }) }
            ];

            for (const test of permissionTests) {
                try {
                    log(`Testing ${test.action} permission`, 'info');
                    const { data, error, count } = await test.query();
                    if (error) {
                        log(`  ${test.action} denied: ${error.message}`, 'error');
                        if (error.code) log(`  Error code: ${error.code}`, 'error');
                    } else {
                        log(`  ${test.action} allowed: ${test.action === 'COUNT' ? count : data?.length} records`, 'success');
                    }
                } catch (e) {
                    log(`  ${test.action} exception: ${e.message}`, 'error');
                }
            }
        }

        async function getSampleData() {
            if (!supabase) {
                log('Please test connection first', 'error');
                return;
            }

            log('=== GETTING SAMPLE DATA ===', 'info');

            try {
                const { data, error } = await supabase
                    .from('inventory_unit_preference')
                    .select('pk, id, data, updated_at')
                    .limit(5);

                if (error) {
                    log(`Sample data error: ${error.message}`, 'error');
                } else {
                    log(`Retrieved ${data?.length || 0} sample records`, 'success');
                    if (data && data.length > 0) {
                        data.forEach((record, index) => {
                            log(`=== RECORD ${index + 1} ===`, 'info');
                            log(`PK: ${record.pk}`, 'info');
                            log(`ID: ${record.id}`, 'info');
                            log(`Updated: ${record.updated_at}`, 'info');
                            if (record.data) {
                                log(`JSONB Data:`, 'info');
                                log(JSON.stringify(record.data, null, 2), 'info');
                            } else {
                                log(`No JSONB data`, 'error');
                            }
                        });
                    }
                }
            } catch (e) {
                log(`Sample data exception: ${e.message}`, 'error');
            }
        }

        // Auto-load environment values on page load
        window.onload = function() {
            log('Supabase Debug Tool loaded', 'success');
            log('Please enter your Supabase credentials and test connection', 'info');
        };
    </script>
</body>
</html>